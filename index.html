<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="孜孜不倦">
<meta property="og:type" content="website">
<meta property="og:title" content="niuxianbin的技术博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="niuxianbin的技术博客">
<meta property="og:description" content="孜孜不倦">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="niuxianbin的技术博客">
<meta name="twitter:description" content="孜孜不倦">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>niuxianbin的技术博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">niuxianbin的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">学海无涯</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/08/11/iOS攻防-注入/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="niuxianbin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/15234019.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="niuxianbin的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/08/11/iOS攻防-注入/" itemprop="url">iOS攻防-注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-11T23:53:23+08:00">
                2017-08-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/21/iOS开发中的锁/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="niuxianbin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/15234019.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="niuxianbin的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/21/iOS开发中的锁/" itemprop="url">iOS开发中的锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-21T14:53:23+08:00">
                2017-07-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/15/预防crash之unrecognized selector/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="niuxianbin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/15234019.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="niuxianbin的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/15/预防crash之unrecognized selector/" itemprop="url">预防crash之unrecognized selector</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-15T20:33:43+08:00">
                2017-05-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="unrecognized-selector原因分析"><a href="#unrecognized-selector原因分析" class="headerlink" title="unrecognized selector原因分析"></a>unrecognized selector原因分析</h2><p>App的崩溃原因有很多种，这篇文章主要阐述防止发送未知消息(unrecognized selector)引起crash的问题。简单来说unrecognized selector类型的crash是因为一个对象调用了一个不属于它的方法导致的,</p>
<h2 id="解决方案分析"><a href="#解决方案分析" class="headerlink" title="解决方案分析"></a>解决方案分析</h2><p><img src="/img/0321.jpeg" alt=""><br>上图是OC经典的消息转发机制，在OC的方法调用中，通过superclass指针逐级向上查找该消息所对应的方法实现。如果直到根类都没有找到这个方法的实现，就会出发消息转发，如上图，所以可以从以上三个方法中实现动态处理unrecognized selector的异常</p>
<h2 id="方案1-重写NSObject的forwardingTargetForSelector"><a href="#方案1-重写NSObject的forwardingTargetForSelector" class="headerlink" title="方案1:重写NSObject的forwardingTargetForSelector"></a>方案1:重写NSObject的forwardingTargetForSelector</h2><p>🐎🐎 思路：</p>
<ul>
<li>NSObject添加分类，重写forwardingTargetForSelector</li>
<li>动态创建Protector类，在forwardingTargetForSelector方法中截获未实现的方法，转发给Protector。并为Protector 动态的添加未实现的方法</li>
<li>动态给Protector类添加方法实现，</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"NSObject+Protector.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#pragma clang diagnostic push</span></span><br><span class="line"><span class="meta">#pragma clang diagnostic ignored <span class="meta-string">"-Wobjc-protocol-method-implementation"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Protector</span>)</span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">id</span>)forwardingTargetForSelector:(SEL)aSelector&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([[<span class="keyword">self</span> <span class="keyword">class</span>] isSubclassInWhiteListClass])</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSString</span> *className = <span class="string">@"ProtectorDynamicClass"</span>;</span><br><span class="line">        Class protocalClass = objc_lookUpClass(className.UTF8String);</span><br><span class="line">        <span class="keyword">if</span> (!protocalClass)</span><br><span class="line">        &#123;</span><br><span class="line">            protocalClass =  objc_allocateClassPair([<span class="built_in">NSObject</span> <span class="keyword">class</span>], className.UTF8String, <span class="number">0</span>);</span><br><span class="line">            objc_registerClassPair(protocalClass);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//此处可不用判断</span></span><br><span class="line">        <span class="keyword">if</span> (![protocalClass isEXit:aSelector]) &#123;</span><br><span class="line">             class_addMethod(protocalClass, aSelector, [protocalClass getIMP], <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        [<span class="keyword">self</span> warningDeveloper:aSelector];</span><br><span class="line">        <span class="keyword">return</span> [[protocalClass alloc]init];</span><br><span class="line">        </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma clang diagnostic pop</span></span><br><span class="line"></span><br><span class="line">+(IMP)getIMP&#123;</span><br><span class="line">    <span class="keyword">return</span> imp_implementationWithBlock(^()&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"PROTECTOR: add IMP Done"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">+(<span class="built_in">BOOL</span>)isEXit:(SEL)sel &#123;</span><br><span class="line">    <span class="built_in">BOOL</span> isExit = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> methodCount = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *selName = <span class="built_in">NSStringFromSelector</span>(sel);</span><br><span class="line">    Method *methodList = class_copyMethodList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;methodCount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methodCount; i++) &#123;</span><br><span class="line">        Method currentMethod = methodList[i];</span><br><span class="line">        SEL currentSEL  =  method_getName(currentMethod);</span><br><span class="line">        <span class="keyword">if</span> ([selName isEqualToString:<span class="built_in">NSStringFromSelector</span>(currentSEL)]) &#123;</span><br><span class="line">            isExit = <span class="literal">YES</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//需要手动释放</span></span><br><span class="line">    free(methodList);</span><br><span class="line">    <span class="keyword">return</span> isExit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)isSubclassInWhiteListClass&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSArray</span> *classNameArray = @[<span class="string">@"NSNull"</span>,<span class="string">@"UIResponder"</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *className <span class="keyword">in</span> classNameArray) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> isSubclassOfClass:<span class="built_in">NSClassFromString</span>(className)]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)warningDeveloper:(SEL)aSelector&#123;</span><br><span class="line"><span class="meta">#if DEBUG</span></span><br><span class="line">    <span class="built_in">NSString</span> *selectorStr = <span class="built_in">NSStringFromSelector</span>(aSelector);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"PROTECTOR: -[%@ %@]"</span>, [<span class="keyword">self</span> <span class="keyword">class</span>], selectorStr);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"PROTECTOR: unrecognized selector \"%@\" sent to instance: %p"</span>, selectorStr, <span class="keyword">self</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"PROTECTOR: call stack: %@"</span>, [<span class="built_in">NSThread</span> callStackSymbols]);</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="方案2-重写NSObject的methodSignatureForSelector"><a href="#方案2-重写NSObject的methodSignatureForSelector" class="headerlink" title="方案2:重写NSObject的methodSignatureForSelector"></a>方案2:重写NSObject的methodSignatureForSelector</h2><p>🐎🐎 思路：</p>
<ul>
<li>NSObject添加分类，重写methodSignatureForSelector</li>
<li>检查是否在白名单内，在的话返回一个空签名，什么也不做</li>
<li>不再范围内，返回原来的签名，走原来的逻辑<br>缺点：<br>此方案会和别的使用AOP的第三方库冲突（例如Aspects），出现奇葩问题，存在优化空间，第三种方案的来源。此处代码省略，参考方案3的代码。</li>
</ul>
<h2 id="方案3-重写少量类的methodSignatureForSelector"><a href="#方案3-重写少量类的methodSignatureForSelector" class="headerlink" title="方案3:重写少量类的methodSignatureForSelector"></a>方案3:重写少量类的methodSignatureForSelector</h2><p>第三方库对 methodSignatureForSelector进行了全局替换，而我们也在NSObject中 进行了全局替换，这就有了冲突。用宏定义的方式对几个类处理即可：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"NSString+Protector.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#define ELOANCN_PROTECTOR(_ClassName_)\</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_ClassName_</span> (<span class="title">ELProtector</span>)\</span></span><br><span class="line">-(<span class="built_in">NSMethodSignature</span> *)methodSignatureForSelector:(SEL)aSelector&#123;\</span><br><span class="line">\</span><br><span class="line"><span class="built_in">NSMethodSignature</span> *signature = [<span class="keyword">super</span> methodSignatureForSelector:aSelector];\</span><br><span class="line"><span class="keyword">if</span> (!signature)\</span><br><span class="line">&#123;\</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSMutableDictionary</span> *signatureCache = <span class="literal">nil</span>;\</span><br><span class="line">    \</span><br><span class="line">    <span class="keyword">if</span> (signatureCache == <span class="literal">nil</span>)\</span><br><span class="line">    &#123;\</span><br><span class="line">        signatureCache = [<span class="built_in">NSMutableDictionary</span> new];\</span><br><span class="line">        \</span><br><span class="line">    &#125;\</span><br><span class="line">    \</span><br><span class="line">    signature = [signatureCache objectForKey:<span class="built_in">NSStringFromSelector</span>(aSelector)];\</span><br><span class="line">    \</span><br><span class="line">    <span class="keyword">if</span> (!signature)\</span><br><span class="line">    &#123;\</span><br><span class="line">        signature = [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:<span class="string">"@"</span>];\</span><br><span class="line">        signatureCache[<span class="built_in">NSStringFromSelector</span>(aSelector)] =signature;\</span><br><span class="line">    &#125;\</span><br><span class="line">    \</span><br><span class="line">    \</span><br><span class="line">&#125;\</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"PROTECTOR: unrecognized selector \"%@\" sent to instance: %p"</span>, <span class="built_in">NSStringFromSelector</span>(aSelector), <span class="keyword">self</span>);\</span><br><span class="line"><span class="keyword">if</span> (TARGET_OS_SIMULATOR)\</span><br><span class="line">&#123;\</span><br><span class="line">    <span class="built_in">NSException</span> *excp = [<span class="built_in">NSException</span> exceptionWithName:<span class="string">@"unrecognized selector"</span> reason:<span class="string">@" unrecognized selector sent to instance"</span> userInfo:<span class="literal">nil</span>];\</span><br><span class="line">    [excp raise];\</span><br><span class="line">&#125;\</span><br><span class="line"><span class="keyword">return</span> signature;\</span><br><span class="line">\</span><br><span class="line">&#125;\</span><br><span class="line"><span class="keyword">@end</span>\</span><br><span class="line"></span><br><span class="line">ELOANCN_PROTECTOR(<span class="built_in">NSString</span>);</span><br><span class="line">ELOANCN_PROTECTOR(<span class="built_in">NSNull</span>);</span><br></pre></td></tr></table></figure></p>
<h2 id="集成进项目的问题"><a href="#集成进项目的问题" class="headerlink" title="集成进项目的问题"></a>集成进项目的问题</h2><ol>
<li>不加白名单，直接给NSObject分类重写消息转发的方法，在项目启动加载时会有莫名的异常抛出。</li>
<li>重写的对应的方法methodSignatureForSelector，项目的第三方库中也可能重写了，需要自己检查处理。</li>
</ol>
<p>思路来源：<a href="https://www.jianshu.com/p/521dd19d4406" target="_blank" rel="noopener">Mad_Mark</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/10/预防crash之刷新UI线程检查/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="niuxianbin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/15234019.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="niuxianbin的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/10/预防crash之刷新UI线程检查/" itemprop="url">预防crash之刷新UI线程检查</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-10T11:33:43+08:00">
                2017-04-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="为什么主线程又叫UI线程"><a href="#为什么主线程又叫UI线程" class="headerlink" title="为什么主线程又叫UI线程"></a>为什么主线程又叫UI线程</h2><p> 为什么都要在主线程中更新UI？,大家都知道UIKit是非线程安全的，但是像UIKit这样大的框架上确保线程安全是一个重大的任务，会带来巨大的成本。假如在两个线程中设置了同一张背景图片，很有可能就会由于背景图片被释放两次，使得程序崩溃。或者某一个线程中遍历找寻某个subView，然而在另一个线程中删除了该subView，那么就会造成错乱。apple有对大部分的绘图方法和诸如UIColor等类改写成线程安全可用，可还是建议将UI操作保证在主线程。</p>
<h2 id="后台线程更新UI会怎样"><a href="#后台线程更新UI会怎样" class="headerlink" title="后台线程更新UI会怎样"></a>后台线程更新UI会怎样</h2><p> 在后台线程更新UI，大概率会crash,有可能显示的效果不符合预期。比如可能会出现丢失动画，页面错乱等问题。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>原理：UIView、CALayer的setNeedsLayout、setNeedsDisplay、setNeedsDisplayInRect:三个方法，是刷新UI的三个关键方法。当调用这三个方法时判断是否在主线程，如果不在主线程调用就让程序crash，在crash堆栈能看出是哪里的问题，因此我们hook三个方法，建议只在开发阶段使用<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define dispatch_main_async_safe(block)\</span></span><br><span class="line"><span class="keyword">if</span> ([<span class="built_in">NSThread</span> isMainThread]) &#123;\</span><br><span class="line">block();\</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;\</span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), block);\</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIView</span> (<span class="title">ThreadCheck</span>)</span></span><br><span class="line"><span class="meta">#if DEBUG</span></span><br><span class="line">+(<span class="keyword">void</span>)load&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">         [<span class="keyword">self</span> swizzleSelector:<span class="keyword">@selector</span>(setNeedsLayout) withSwizzledSelector:<span class="keyword">@selector</span>(EL_setNeedsLayout)];</span><br><span class="line">         [<span class="keyword">self</span> swizzleSelector:<span class="keyword">@selector</span>(setNeedsDisplay) withSwizzledSelector:<span class="keyword">@selector</span>(EL_setNeedsDisplay)];</span><br><span class="line">         [<span class="keyword">self</span> swizzleSelector:<span class="keyword">@selector</span>(setNeedsDisplayInRect:) withSwizzledSelector:<span class="keyword">@selector</span>(EL_setNeedsDisplayInRect:)];</span><br><span class="line">        </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">-(<span class="keyword">void</span>)EL_setNeedsLayout&#123;</span><br><span class="line">    <span class="keyword">if</span>(![<span class="built_in">NSThread</span> isMainThread])&#123;</span><br><span class="line">        [<span class="keyword">self</span> CrashOnSimulator];</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_main_async_safe(^()&#123;</span><br><span class="line">        [<span class="keyword">self</span> EL_setNeedsLayout];</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">-(<span class="keyword">void</span>)EL_setNeedsDisplay&#123;</span><br><span class="line">    <span class="keyword">if</span>(![<span class="built_in">NSThread</span> isMainThread])&#123;</span><br><span class="line">        [<span class="keyword">self</span> CrashOnSimulator];</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_main_async_safe(^()&#123;</span><br><span class="line">        [<span class="keyword">self</span> EL_setNeedsDisplay];</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">-(<span class="keyword">void</span>)EL_setNeedsDisplayInRect:(<span class="built_in">CGRect</span>)Rect&#123;</span><br><span class="line">    <span class="keyword">if</span>(![<span class="built_in">NSThread</span> isMainThread])&#123;</span><br><span class="line">        [<span class="keyword">self</span> CrashOnSimulator];</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_main_async_safe(^()&#123;</span><br><span class="line">        [<span class="keyword">self</span> EL_setNeedsDisplay];</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">-(<span class="keyword">void</span>)CrashOnSimulator&#123;</span><br><span class="line">    <span class="keyword">if</span> (TARGET_OS_SIMULATOR) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSException</span> *exception = [[<span class="built_in">NSException</span> alloc] initWithName:<span class="string">@"子线程刷新UI了"</span> reason:<span class="literal">nil</span> userInfo:<span class="literal">nil</span>];</span><br><span class="line">        [exception raise];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"禁止子线程刷新UI"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)swizzleSelector:(SEL)originalSelector withSwizzledSelector:(SEL)swizzledSelector&#123;</span><br><span class="line">    </span><br><span class="line">    Class <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">    </span><br><span class="line">    Method originalMethod = class_getInstanceMethod(<span class="keyword">class</span>, originalSelector);</span><br><span class="line">    </span><br><span class="line">    Method swizzledMethod = class_getInstanceMethod(<span class="keyword">class</span>, swizzledSelector);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">BOOL</span> didAddMethod = class_addMethod(<span class="keyword">class</span>,originalSelector,</span><br><span class="line">                                        </span><br><span class="line">                                        method_getImplementation(swizzledMethod),</span><br><span class="line">                                        </span><br><span class="line">                                        method_getTypeEncoding(swizzledMethod));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (didAddMethod) &#123;</span><br><span class="line">        </span><br><span class="line">        class_replaceMethod(<span class="keyword">class</span>,swizzledSelector,</span><br><span class="line">                            </span><br><span class="line">                            method_getImplementation(originalMethod),</span><br><span class="line">                            </span><br><span class="line">                            method_getTypeEncoding(originalMethod));</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">        method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure></p>
<p>CALayer的代码如出一辙，省略</p>
<h2 id="可优化空间"><a href="#可优化空间" class="headerlink" title="可优化空间"></a>可优化空间</h2><ol>
<li>冗余代码过多，可通过宏定义的方式以更优雅的方式实现，但是宏用的太多会影响编译速度。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/25/预防crash之基本数据容错机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="niuxianbin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/15234019.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="niuxianbin的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/02/25/预防crash之基本数据容错机制/" itemprop="url">预防crash之基本数据容错机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-25T22:33:43+08:00">
                2017-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基本数据类导致的crash"><a href="#基本数据类导致的crash" class="headerlink" title="基本数据类导致的crash"></a>基本数据类导致的crash</h2><p>一般对于数组\字典等基本数据类型的增删改查，由于数据的不确定性，经常会导致crash，🌰如下：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *arr = @[@<span class="number">1</span>,@<span class="number">2</span>,@<span class="number">3</span>,@<span class="number">4</span>];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *arrM = @[].mutableCopy;</span><br><span class="line"><span class="built_in">NSDictionary</span> *dic = @&#123;<span class="string">@"test"</span>:<span class="string">@"dic"</span>&#125;;</span><br><span class="line"></span><br><span class="line">[arr objectAtIndex:<span class="number">5</span>];</span><br><span class="line">[arrM addObject:<span class="literal">nil</span>];</span><br><span class="line">[dic objectForKey:<span class="string">@"test1"</span>];</span><br></pre></td></tr></table></figure></p>
<p>以上几种方式就会造成crash，</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>思路很简单，可以通过swizzle的方式hook增删改查的方法，执行自定义的对应的增删改查方法，在自定义的方法中进行本数据类型的安全检查。即可对基本类型作出容错。我们早期的项目翼龙贷理财端就是这个思路，给NSArray\ NSMutableArray\ NSDictionary等加Category,hook对应的方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)exchangeAddObjectMethod&#123;</span><br><span class="line">    </span><br><span class="line">    [objc_getClass(<span class="string">"__NSArrayM"</span>) swizzleSelector:<span class="keyword">@selector</span>(addObject:) withSwizzledSelector:<span class="keyword">@selector</span>(safeAddObject:)];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)safeAddObject:(<span class="keyword">id</span>)obj &#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="built_in">NSAssert</span>(obj != <span class="literal">nil</span>, <span class="string">@"add nil object into NSMutableArray"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> safeAddObject:obj];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="完美解决方案"><a href="#完美解决方案" class="headerlink" title="完美解决方案"></a>完美解决方案</h2><p>github上已经有完美的轮子了，没必要在自己造轮子了，入口<a href="https://github.com/jasenhuang/NSObjectSafe" target="_blank" rel="noopener">NSObjectSafe</a> 思路一样，实现的更优雅完美 🍎 🍎 🍎 🍎 🍎</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/03/python读取Excel文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="niuxianbin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/15234019.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="niuxianbin的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/03/python读取Excel文件/" itemprop="url">python处理Excel文件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-03T21:43:23+08:00">
                2017-01-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="python的题外话啊"><a href="#python的题外话啊" class="headerlink" title="python的题外话啊"></a>python的题外话啊</h4><p>题外话，这个需求来自于老婆大人🙍 ，本来也就想学习python，刚好有了动力😂.项目APP瘦身刚好能用到python</p>
<h4 id="python环境"><a href="#python环境" class="headerlink" title="python环境"></a>python环境</h4><p> Mac自带的python环境，省了安装过程，在终端输入python即可查看。<br> 推荐比较好用的集成开发环境：<a href="https://www.jetbrains.com/pycharm/download/" target="_blank" rel="noopener">PyCharm</a> </p>
<h4 id="语法基础"><a href="#语法基础" class="headerlink" title="语法基础"></a>语法基础</h4><p> python的基本数据类型：</p>
<ul>
<li>Numbers（数字）</li>
<li>String（字符串）</li>
<li>List（列表）</li>
<li>Tuple（元组）</li>
<li>Dictionary（字典）<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">textNum = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">testStr = <span class="string">"hahaha"</span></span><br><span class="line"></span><br><span class="line">testList = [<span class="number">1</span>,<span class="number">2</span>,<span class="string">"hehe"</span>]</span><br><span class="line"></span><br><span class="line">testTuple = (<span class="number">1</span>,<span class="string">"3"</span>,<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">testDic = &#123;<span class="string">"niu"</span>:<span class="number">123</span>,<span class="string">"ha"</span>:<span class="string">"hehe"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>  textNum,testStr,testList,testTuple,testDic</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>类型和swift里的基本一致，方便使用的是不用声明类型</p>
<h3 id="流程控制语句"><a href="#流程控制语句" class="headerlink" title="流程控制语句"></a>流程控制语句</h3><p>python 的代码块不使用大括号 {} 来控制类，函数以及其他逻辑判断。python 最具特色的就是用缩进来写模块。 如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printme</span><span class="params">( str )</span>:</span></span><br><span class="line">   <span class="string">"打印任何传入的字符串"</span></span><br><span class="line">   <span class="keyword">print</span> str;</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>  printme(<span class="number">123</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#流程控制语句</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">True</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"True"</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"false"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">False</span>):</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"haha"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> [<span class="string">"niu"</span>,<span class="string">"xian"</span>,<span class="string">"bin"</span>]:</span><br><span class="line">    <span class="keyword">print</span> obj</span><br></pre></td></tr></table></figure></p>
<h4 id="python-处理文件"><a href="#python-处理文件" class="headerlink" title="python 处理文件"></a>python 处理文件</h4><p>python基础很容易，现在开始实战了。读取和写入需要依赖三个第三方库：<a href="https://pypi.python.org/pypi/xlwt" target="_blank" rel="noopener">xlwt</a> ，<a href="https://pypi.python.org/pypi/xlrd" target="_blank" rel="noopener">xlrd</a> , xlutils，安装过程也很简单，网上很多。<br>媳妇的具体需求是两个sheet表，把早退人员的原因根据第二表打卡时间分析出来<br>具体代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> xlrd</span><br><span class="line"><span class="keyword">import</span> xlwt</span><br><span class="line"><span class="keyword">from</span> xlutils.copy <span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="comment">#乱码问题解决</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">fname = <span class="string">"123.xlsx"</span></span><br><span class="line">bk = xlrd.open_workbook(fname)</span><br><span class="line"><span class="comment">#copy一份用来写入数据</span></span><br><span class="line">newb = copy(bk)</span><br><span class="line">shxrange = range(bk.nsheets)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    Sheet1 = bk.sheet_by_name(<span class="string">"Sheet1"</span>)</span><br><span class="line">    Sheet2 = bk.sheet_by_name(<span class="string">"Sheet2"</span>)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"no sheet in %s named Sheet1"</span> % fname</span><br><span class="line"><span class="comment"># 获取行数</span></span><br><span class="line">nrows = Sheet1.nrows</span><br><span class="line"><span class="comment"># 获取列数</span></span><br><span class="line">ncols = Sheet1.ncols</span><br><span class="line"><span class="keyword">print</span> <span class="string">"sheet1:nrows %d, ncols %d"</span> % (nrows, ncols)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取行数</span></span><br><span class="line">nrows2 = Sheet2.nrows</span><br><span class="line"><span class="comment"># 获取列数</span></span><br><span class="line">ncols2 = Sheet2.ncols</span><br><span class="line"><span class="keyword">print</span> <span class="string">"sheet2:nrows %d, ncols %d"</span> % (nrows2, ncols2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------sheet1----------</span></span><br><span class="line"><span class="comment">#人员列表</span></span><br><span class="line">peopleList = Sheet1.col_values(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#早退时间</span></span><br><span class="line">lltimeList = Sheet1.col_values(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># 获取早退的人员列</span></span><br><span class="line">listValue = Sheet1.col_values(<span class="number">9</span>)</span><br><span class="line"><span class="comment">#存储早退人员相关信息</span></span><br><span class="line">zauotuiList = []</span><br><span class="line"></span><br><span class="line"><span class="comment">#-------sheet2----------</span></span><br><span class="line">people2List = Sheet2.col_values(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">lltime2List = Sheet2.col_values(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入早退原因</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">excelUpdate</span><span class="params">(excel,row,content)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    更新已有excel, 是copy一份再做更新</span></span><br><span class="line"><span class="string">    :param excel:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    wbsheet = newb.get_sheet(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    wbsheet.write(row, <span class="number">10</span>, content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> index <span class="keyword">in</span> range(len(listValue)):</span><br><span class="line">     <span class="keyword">if</span> (<span class="string">"早退"</span> <span class="keyword">in</span> listValue[index]):</span><br><span class="line">        peoplename = peopleList[index]</span><br><span class="line">        <span class="keyword">for</span> peopleindex <span class="keyword">in</span> range(len(people2List)):</span><br><span class="line">            <span class="keyword">if</span> (peoplename == people2List[peopleindex]):</span><br><span class="line">             <span class="comment">#   print  lltime2List[peopleindex][2:(lltime2List[peopleindex].index(" "))],lltimeList[index][0:(lltimeList[index].index(" "))]</span></span><br><span class="line">                <span class="keyword">if</span> ((lltime2List[peopleindex][<span class="number">2</span>:(lltime2List[peopleindex].index(<span class="string">" "</span>))] == lltimeList[index][<span class="number">0</span>:(lltimeList[index].index(<span class="string">" "</span>))]) <span class="keyword">and</span> lltime2List[peopleindex][<span class="number">11</span>:<span class="number">13</span>] &gt;=<span class="number">16</span> ):</span><br><span class="line">                   <span class="comment"># print "早退人员名字：%s 日期：%s 当天直播时间: %s" % (peoplename,lltimeList[index],lltime2List[peopleindex])</span></span><br><span class="line">                    excelUpdate(newb,index,unicode(<span class="string">"晚上有直播"</span>, <span class="string">"utf8"</span>))</span><br><span class="line">                   <span class="comment"># print  lltime2List[peopleindex][11:13]</span></span><br><span class="line">                <span class="comment"># print lltime2List[peopleindex],people2List[peopleindex]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">         <span class="comment"># if peopleList[index] ==</span></span><br><span class="line">         <span class="comment"># print "%s %s %s" % (peopleList[index],listValue[index],lltimeList[index][0:(lltimeList[index].index(" "))])</span></span><br><span class="line">         </span><br><span class="line"><span class="comment">#生成新的Excel文件存储磁盘</span></span><br><span class="line">newb.save(<span class="string">"123456.xlsx"</span>)</span><br></pre></td></tr></table></figure></p>
<h4 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h4><p>学习新语言基础很简单，但是真正使用还是会遇到各种问题，但是在实践中才能学的更快。🍎🍎后期打算自己写APP瘦身脚本，fighting，感谢数据部大神@司马指点</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/01/iOS runtime的isa指针/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="niuxianbin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/15234019.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="niuxianbin的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/01/iOS runtime的isa指针/" itemprop="url">iOS runtime 之 isa指针</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-01T22:33:43+08:00">
                2016-12-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="OC的类和对象的关系图"><a href="#OC的类和对象的关系图" class="headerlink" title="OC的类和对象的关系图"></a>OC的类和对象的关系图</h2><p><img src="/img/0326.jpeg" alt=""><br>经典图镇楼💛💛💛💛💛</p>
<h2 id="isa"><a href="#isa" class="headerlink" title="isa"></a>isa</h2><p>objc.h头文件的解释<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// An opaque type that represents an Objective-C class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Represents an instance of a class.</span></span><br><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A pointer to an instance of a class.</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br></pre></td></tr></table></figure></p>
<p>runtime.h文件中类的定义<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line"><span class="meta">#if !__OBJC2__</span></span><br><span class="line">    Class _Nullable super_class                              OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * _Nonnull name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure></p>
<p>1 id和Class都是指针类型<br>2 对象和类都有isa指针；</p>
<h2 id="isa的值"><a href="#isa的值" class="headerlink" title="isa的值"></a>isa的值</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">NSObject</span> *object = [[<span class="built_in">NSObject</span> alloc]init];</span><br><span class="line"> object-&gt;isa;</span><br><span class="line"><span class="comment">//OC的isa指针无法向C++的方式直接使用，必须通过object_getClass()/object_setClass()使用</span></span><br></pre></td></tr></table></figure>
<h2 id="isa的总结"><a href="#isa的总结" class="headerlink" title="isa的总结"></a>isa的总结</h2><p>1 每一个对象本质上都是一个类的实例。其中类定义了成员变量和成员方法的列表。对象通过对象的isa指针指向类。</p>
<p>2 每一个类本质上都是一个对象，类其实是元类（meteClass）的实例。元类定义了类方法的列表。类通过类的isa指针指向元类。</p>
<p>3 所有的元类最终继承一个根元类，根元类isa指针指向本身，形成一个封闭的内循环</p>
<h2 id="isa的妙用"><a href="#isa的妙用" class="headerlink" title="isa的妙用"></a>isa的妙用</h2><p>1  系统通过指针混写(isa-swizzling)的方式实现KVO：就是将当前对象的isa指针指向自己运行时生成的子类，然后重写了子类对应的setter方法,在setter方法里执行KVO的方法，然后再[super setter]赋值。<br>自己按照以上思路实现了下KVO，代码量大，贴出部分核心代码：<br>添加监听方法中🍎🍎🍎：<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *oldClassName = <span class="built_in">NSStringFromClass</span>(<span class="keyword">self</span>.class);</span><br><span class="line">   <span class="built_in">NSString</span> *runtimeName = [<span class="string">@"NIU_"</span> stringByAppendingString:oldClassName];</span><br><span class="line">   Class kvoClass;</span><br><span class="line">   kvoClass = objc_lookUpClass(runtimeName.UTF8String);</span><br><span class="line">   <span class="keyword">if</span> (!kvoClass) &#123;</span><br><span class="line">       <span class="comment">//动态创建class</span></span><br><span class="line">       kvoClass = objc_allocateClassPair(<span class="keyword">self</span>.class, kvoClassName.UTF8String, <span class="number">0</span>);</span><br><span class="line">       objc_registerClassPair(kvoClass);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//实现自己的setter方法</span></span><br><span class="line">   class_addMethod(kvoClass,<span class="built_in">NSSelectorFromString</span>(setterStr), (IMP)setterIMP, <span class="string">"v@:@"</span>);</span><br><span class="line">   <span class="comment">//将当前对象isa指针指向kvoClass</span></span><br><span class="line">   object_setClass(<span class="keyword">self</span>, kvoClass);</span><br></pre></td></tr></table></figure></p>
<p>自己实现的setter方法中部分🍎🍎🍎<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_super superClazz = &#123;</span><br><span class="line">        .receiver = <span class="keyword">self</span>,</span><br><span class="line">        .super_class = class_getSuperclass(object_getClass(<span class="keyword">self</span>))</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//调用super setter赋值</span></span><br><span class="line">    <span class="keyword">void</span> (*action)(<span class="keyword">void</span> *,SEL,<span class="keyword">id</span>) =(<span class="keyword">void</span> (*)(<span class="keyword">void</span> *, SEL, <span class="keyword">id</span>))objc_msgSendSuper;</span><br><span class="line">    action(&amp;superClazz, _cmd, newValue);</span><br><span class="line">    <span class="comment">//执行自己监听回调</span></span><br><span class="line">    block();</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/23/atomic和线程安全/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="niuxianbin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/15234019.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="niuxianbin的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/23/atomic和线程安全/" itemprop="url">atomic和线程安全</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-23T20:13:02+08:00">
                2016-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="修饰词"><a href="#修饰词" class="headerlink" title="修饰词"></a>修饰词</h2><p> 一般我们写属性都是nonatomic,这个属性效率高，但是不是线程安全的，多线程造作会造成crash问题，所以有了atomic，atomic是对setter/getter方法是线程安全，不代表这个属性的操作是线程安全的<br>，笔者深有体会～～<br>如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property(atomic,strong) NSMutableArray *arrayM;</span><br></pre></td></tr></table></figure></p>
<p>对于这个属性只能保证self.arrayM这样调用是线程安全，[self.arrayM addObject:];这样使用并不是线程安全，如果有多线程访问，还是可能会crash的，此处只有通过锁来解决，</p>
<p>stackoverflow经典关于atomic的讲解<br><a href="https://stackoverflow.com/questions/588866/whats-the-difference-between-the-atomic-and-nonatomic-attributes" target="_blank" rel="noopener">What’s the difference between the atomic and nonatomic attributes?</a>  </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/26/GCD延迟操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="niuxianbin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/15234019.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="niuxianbin的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/26/GCD延迟操作/" itemprop="url">iOS延迟执行</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-26T20:31:15+08:00">
                2016-10-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="延时执行"><a href="#延时执行" class="headerlink" title="延时执行"></a>延时执行</h2><p>最近996，两个新项目加码，博客越来越慢了。记录下自己项目的注意点。言归正传。一般延迟执行最常用的：</p>
<ul>
<li>performSelector:withObject:afterDelay</li>
<li>NSTimer</li>
<li>dispatch_after<br>三者的有何不同和相同点呢？<br>performSelector:withObject:afterDelay 是基于runloop实现的，所以这个使用应该注意，!!!!在子线程使用需要开启runloop。官网解释</li>
</ul>
<blockquote>
<p>This method sets up a timer to perform the aSelector message on the current thread’s run loop. The timer is configured to run in the default mode (NSDefaultRunLoopMode). When the timer fires, the thread attempts to dequeue the message from the run loop and perform the selector. It succeeds if the run loop is running and in the default mode; otherwise, the timer waits until the run loop is in the default mode</p>
</blockquote>
<p>其实这个是系统底层创建一个timer，说到底这个是可以NStimer实现的延时方法，<br>这个延时可以取消，系统提供两个可以取消操作的方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ (void)cancelPreviousPerformRequestsWithTarget:(id)aTarget selector:(SEL)aSelector object:(nullable id)anArgument;</span><br><span class="line">+ (void)cancelPreviousPerformRequestsWithTarget:(id)aTarget;</span><br></pre></td></tr></table></figure></p>
<p>NStimer也是基于runloop，使用需要加入runloop，因此也存在子线程使用可能出现问题（timer的也可能产生循环引用问题也要注意）<br>以上两个的好处就是都能取消，</p>
<h2 id="dispatch-after"><a href="#dispatch-after" class="headerlink" title="dispatch_after"></a>dispatch_after</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//使用方式</span><br><span class="line"> dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(5 * NSEC_PER_SEC)), dispatch_queue_create(0, 0), ^&#123;</span><br><span class="line">        NSLog(@&quot;...dispatch_after...&quot;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>官网解释</p>
<blockquote>
<p>This function waits until the specified time and then<br>asynchronously adds block to the specified queue.</p>
</blockquote>
<p>意思就是这个是延迟提交，就是延时后把block提交到加入队列的的线程，而不是提交到对应的线程延迟执行，因此这个无法取消操作。</p>
<h2 id="延迟操作取消"><a href="#延迟操作取消" class="headerlink" title="延迟操作取消"></a>延迟操作取消</h2><p>[[NSRunLoop currentRunLoop] run]; ：开始运行循环<br>开启循环之前，必须有定时源或者输入源给他，不然runloop运行完会退出。<br>performSelector:withObject:afterDelay 这个方法底层创建的timer，NStimer也是timer，但是需要手动加入运行循环，通过打runloop有何不同,来观察cancle操作怎么实现原理，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">        [[NSRunLoop currentRunLoop ] run];</span><br><span class="line">        NSLog(@&quot;0:%@&quot;,[NSRunLoop currentRunLoop]);</span><br><span class="line">        [self performSelector:@selector(test) withObject:nil afterDelay:2.0];</span><br><span class="line">        NSLog(@&quot;1:%@&quot;,[NSRunLoop currentRunLoop]);</span><br><span class="line">        [self performSelector:@selector(test) withObject:nil afterDelay:4.0];</span><br><span class="line">        NSLog(@&quot;2:%@&quot;,[NSRunLoop currentRunLoop]);</span><br><span class="line">        [self performSelector:@selector(test) withObject:nil afterDelay:4.0];</span><br><span class="line">        NSLog(@&quot;3:%@&quot;,[NSRunLoop currentRunLoop]);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>
<p>因为有很多属性，截图不方便，我就手动复制了log日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 :timers = (null),</span><br><span class="line">1 :timers = &lt;CFArray 0x6040000af180 [0x1053dcbb0]&gt;&#123;type = mutable-small, count = 1, values = (...</span><br><span class="line">2 :timers = &lt;CFArray 0x6040000af180 [0x1053dcbb0]&gt;&#123;type = mutable-small, count = 2, values = (...</span><br><span class="line">3 :timers = &lt;CFArray 0x6040000af180 [0x1053dcbb0]&gt;&#123;type = mutable-small, count = 3, values = (...</span><br></pre></td></tr></table></figure></p>
<p>以上原理：timer是放到runloop的 timers数组中了，在runloop run的时候Observer执行timers的timer。<br>取消的方式就是在runloop run之前把timer取消了:<br><img src="/img/6.png" alt=""><br>开发者文档对cancle的解释：就是取消的是下一次的 next run loop cycle 的timer，以下代码的test方法执行次数结果就清晰明了了：3次和1次<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">        </span><br><span class="line">        for (int i=0; i&lt;3 ; i++) &#123;</span><br><span class="line">            [NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(test) object:nil];</span><br><span class="line">            [self performSelector:@selector(test) withObject:nil afterDelay:1];</span><br><span class="line">              [[NSRunLoop currentRunLoop] run];</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">        </span><br><span class="line">        for (int i=0; i&lt;3 ; i++) &#123;</span><br><span class="line">            [NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(test) object:nil];</span><br><span class="line">            [self performSelector:@selector(test) withObject:nil afterDelay:1];</span><br><span class="line">        &#125;</span><br><span class="line">        [[NSRunLoop currentRunLoop] run];</span><br><span class="line">        </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/09/18/iOS编码规范-二/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="niuxianbin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/upload/15234019.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="niuxianbin的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/18/iOS编码规范-二/" itemprop="url">iOS编码规范-associated_key</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-18T21:42:37+08:00">
                2016-09-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>学习第三方源码时发现associated_key的花式写法</p>
<h4 id="常规套路-NSString"><a href="#常规套路-NSString" class="headerlink" title="常规套路-NSString"></a>常规套路-NSString</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objc_setAssociatedObject(vc, <span class="string">@"objKey"</span>, <span class="string">@"123"</span>, OBJC_ASSOCIATION_ASSIGN);</span><br></pre></td></tr></table></figure>
<h4 id="变量的静态内存地址"><a href="#变量的静态内存地址" class="headerlink" title="变量的静态内存地址"></a>变量的静态内存地址</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指向字符串的地址</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> * JORAutoScrollAssociatedKeyController = <span class="string">"JORAutoScrollAssociatedKeyController"</span>;</span><br><span class="line">objc_setAssociatedObject(<span class="keyword">self</span>, JORAutoScrollAssociatedKeyController, scrollController, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line"><span class="comment">// 指向自己的地址</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> * eventAssociatedKey = &amp;eventAssociatedKey;</span><br><span class="line">objc_setAssociatedObject(<span class="keyword">self</span>, eventAssociatedKey, delegate, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br></pre></td></tr></table></figure>
<h4 id="默认初始化的变量-常量地址"><a href="#默认初始化的变量-常量地址" class="headerlink" title="默认初始化的变量/常量地址"></a>默认初始化的变量/常量地址</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// SDWebImage</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> imageURLKey;</span><br><span class="line">objc_setAssociatedObject(<span class="keyword">self</span>, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">objc_getAssociatedObject(<span class="keyword">self</span>, &amp;imageURLKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// YYAdd</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> block_key;</span><br><span class="line">objc_setAssociatedObject(<span class="keyword">self</span>, &amp;block_key, target, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">objc_getAssociatedObject(<span class="keyword">self</span>, &amp;block_key);</span><br></pre></td></tr></table></figure>
<h4 id="selector的地址"><a href="#selector的地址" class="headerlink" title="selector的地址"></a>selector的地址</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AFNetWorking:使用 @selector</span></span><br><span class="line">- (AFImageDownloadReceipt *)af_activeImageDownloadReceipt &#123;</span><br><span class="line">    <span class="keyword">return</span> (AFImageDownloadReceipt *)objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(af_activeImageDownloadReceipt));</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)af_setActiveImageDownloadReceipt:(AFImageDownloadReceipt *)imageDownloadReceipt &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(af_activeImageDownloadReceipt), imageDownloadReceipt, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实@selector，就是方法本身的隐藏参数_cmd，两者是一样的。</p>
<h4 id="x1F34E-结尾-x1F34E"><a href="#x1F34E-结尾-x1F34E" class="headerlink" title="&#x1F34E;结尾&#x1F34E;"></a>&#x1F34E;结尾&#x1F34E;</h4><p>萝卜白菜，个有所爱，我还是喜欢默认值的方式</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/upload/15234019.jpeg"
                alt="niuxianbin" />
            
              <p class="site-author-name" itemprop="name">niuxianbin</p>
              <p class="site-description motion-element" itemprop="description">孜孜不倦</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">niuxianbin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
